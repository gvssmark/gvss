
<!doctype html>
<html lang="en">
<head>
 <script src="index.js" defer></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ed8d8d" />
    <link rel="apple-touch-icon" href="ibap512.png">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins&effect=neon|outline|emboss|shadow-multiple">

    <meta name="viewport" content="width=device-width, maximum-scale=1 , initial-scale=1.0">

<meta charset="utf-8" />

<title>IBAP Retirees</title>
<style>
  :root{--bg:#f6f7fb;--card:#fff;--accent:#0b67ff;--muted:#666}
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  body{background:var(--bg);color:#111}
  /* header fixed */
  header{position:fixed;left:0;right:0;top:0;height:56px;background:#ed8d8d;border-bottom:1px solid #eee;display:flex;align-items:center;gap:12px;padding:0 12px;z-index:30}
  header h1{margin:0;font-size:18px;letter-spacing:1px; text-align:center}
  .hamb{width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:8px;cursor:pointer}
  .hamb svg{width:22px;height:22px}
  main{padding:76px 12px 24px 12px;max-width:980px;margin:0 auto}
  /* login */
  .login-box{background:var(--card);padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(20,20,40,0.04);max-width:560px;margin:20px auto}
  label{display:block;margin-bottom:6px;font-weight:600}
  input[type="number"], input[type="search"], input[type="text"]{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;font-size:15px}
  .row{display:flex;gap:8px;align-items:center;margin-top:10px}
  button{background:var(--accent);color:#fff;padding:10px 14px;border-radius:8px;border:0;font-weight:600;cursor:pointer}
  button.secondary{background:#eee;color:#111}
  small.muted{color:var(--muted);display:block;margin-top:6px}
  /* report list */
  /* search area fixed (sticky) right under header */
  .controls{display:flex;gap:8px;margin-bottom:12px;align-items:center;flex-wrap:wrap;
            position:sticky; top:56px; background:var(--bg); z-index:25;
            padding:8px 12px; border-bottom:1px solid #eee;}
  .cards{display:grid;grid-template-columns: repeat(auto-fill,minmax(240px,1fr));gap:12px; padding-top:8px}
  .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 12px rgba(10,10,30,0.03);cursor:pointer}
  .card h3{margin:0;font-size:16px}
  .card p{margin:6px 0 0 0;color:var(--muted);font-size:13px}
  /* sidebar (hamb menu) */
  .sidebar{position:fixed;left:0;top:56px;bottom:0;width:280px;background:#fff;border-right:1px solid #eee;padding:14px;transform:translateX(-110%);transition:transform .25s ease;z-index:40;overflow:auto}
  .sidebar.open{transform:translateX(0)}
  .sidebar h4{margin:0 0 10px 0}
  .menu-item{padding:10px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
  .menu-item:hover{background:#f2f6ff}
  /* modal */
  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:60}
  .modal-back.open{display:flex}
  .modal{background:#fff;padding:16px;border-radius:12px;max-width:700px;width:95%;max-height:85vh;overflow:auto;box-shadow:0 20px 40px rgba(0,0,0,0.2)}
  .modal .close{float:right;cursor:pointer;padding:6px; display:none; }
  .badge{display:inline-block;padding:6px 8px;border-radius:999px;background:#f1f3ff;color:#0b67ff;font-weight:700;font-size:12px}
  /* responsive tweaks */
  @media (max-width:520px){
    header h1{font-size:15px}
    .cards{grid-template-columns:1fr}
    .sidebar{width:88%}
  }
  .topnote{font-size:13px;color:var(--muted);margin-top:8px}
#goUpBtn  {position:fixed;  top:50%;  float:right;right:0;  width:50px;  height:50px;  background:red;  color:#fff;  border-radius:50px;  display:none;  align-items:center;
  justify-content:center;  cursor:pointer;  z-index:100;  font-size:20px;  box-shadow:0 2px 8px rgba(0,0,0,0.2);}
  
  #myphoto {width:110px}
.modal {
  background: #c02595;
  color: #fff;
  padding: 8px;
  border-radius: 15px;
  max-width:400px;
}
#modalTitle {
  font-size: 22px;
  font-weight: bold;
  margin-bottom:10px;
  letter-spacing: 0.5px;
  text-align: center;
  
}
#modalBody {
  font-size: small;
  color: #fff;
}
#myphoto img {
  width: 100px;
  height: 120px;
  border-radius: 12px;
  object-fit: cover;
  box-shadow: 0 2px 12px rgba(0,0,0,0.2);
}
.highlight {
  background: #fff700;
  color: #222;
  padding: 2px 4px;
  border-radius: 3px;
  font-weight: bold;
}
a, a:visited, a:active {
  color: #ffee7c;
  text-decoration: underline;
}
 #refreshData {display:none}
/* Carousel styles for events cards */
#carouselWrap {
  position: relative;
  width: 100%;
  max-width: 340px;
  margin: 0 auto 16px auto;
  min-height: 280px;
  overflow: hidden;
}
.carousel-card {
  position: absolute;
  left: 0; top: 0; right: 0; bottom: 0;
  opacity: 0;
  transition: opacity 0.5s cubic-bezier(0.4,0,0.2,1);
  pointer-events: none;
  z-index: 5;
  min-height: 240px; /* <-- add this */
  background: #fff; /* to ensure text is visible */
  overflow: auto;   /* allow overflow if needed */
  display: flex; flex-direction: column; align-items: center;
  }
.carousel-card.active {
  opacity: 1;
  pointer-events: auto;
  z-index: 10;
}

#carouselDots {
  display: flex;
  gap: 6px;
  justify-content: center;
  margin-top:8px;
}
.carousel-dot {
  width: 10px; height: 10px; border-radius:50%; background: #ed8d8d7d;
  cursor: pointer;
}
.carousel-dot.active {
  background: #ed8d8d;
}

</style>
</head>
<body>
<header>
  <div id="hamb" class="hamb" title="Menu" aria-label="Menu">
    <svg viewBox="0 0 24 24"><path fill="currentColor" d="M3 6h18v2H3zM3 11h18v2H3zM3 16h18v2H3z"/></svg>
  </div>
  <h1>IBAP RETIREES</h1>
  <div style="flex:1"></div>
  <div id="status" style="font-size:13px;color:var(--muted)"></div>
</header>

<!-- Sidebar / Hamburger menu -->
<aside id="sidebar" class="sidebar" aria-hidden="true">
  <h4>Menu</h4>
  <div class="menu-item" data-action="listMembers">1. List of Members <span class="badge" id="countMembers"></span></div>
  <div class="menu-item" data-action="eventsWeek">2. Events this week</div>
  <div class="menu-item" data-action="membersLiving">3. Members living In</div>
  <div class="menu-item" data-action="branchesList">4. Branches list</div>
  <div class="menu-item" data-action="dataCorrection">5. Data correction</div>
  <div class="menu-item" data-action="otherLinks">6. Other Links</div>
  <div class="menu-item" data-action="about">7. About</div>
  
  <hr/>
  <div style="margin-top:8px">
    <button id="clearLocal" class="secondary" style="width:100%">Clear local mylocal</button>
  </div>
</aside>

<main>
  <!-- Login view -->
  <section id="loginView">
    <div class="login-box">
      <label for="srnoInput">Enter SR No</label>
      <input id="srnoInput" type="number" inputmode="numeric" placeholder="e.g. 1948" />
      <div class="row" style="margin-top:12px">
        <button id="srSubmit">Submit</button>
 <!--       <button id="useLocal" class="secondary">Use local mylocal</button>
      </div>
      <small class="muted">If you have mylocal stored (format: srno#Name#Mon dd yyyy hh:mm), click "Use local mylocal".</small> -->
      <div id="loginMsg" class="topnote"></div>
    </div>
  </section>

  <!-- Report view -->
  <section id="reportView" style="display:none">
    <div class="controls">
      <input id="searchInput" type="search" placeholder="Search by name, srno, city..." />
      <button id="refreshData" class="secondary">Refresh</button>
      <div style="flex:1"></div>
      
      <div id="reportInfo" class="topnote"></div>
    </div>

    <div id="reportArea">
      <div id="cards" class="cards"></div>
    </div>
  </section>
</main>

<!--
<div id="goUpBtn" style="
  position:fixed;bottom:24px;right:24px;width:25px;height:25px;
  background:red;color:#fff;border-radius:50px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;z-index:100;font-size:14px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
  â†‘
</div> -->
<div id="goUpBtn" style=" ">  TOP</div>
<!-- Modal -->
<div id="modalBack" class="modal-back" role="dialog" aria-modal="true">
  <div class="modal" id="modal">
    <div >
      <h3 id="modalTitle" style="text-align:centre; color:white;"></h3>
      <div class="close" id="modalClose" title="Close" style="font-size:1.5em;">&times;</div>
    </div>
    <div >
      <div>
        <div id="modalBody"></div>
      </div>
      <!--<div id="myphoto" style="min-width:110px; text-align:center;"></div> -->
    </div>
  </div>
</div>




<script>
/* ---------- Configuration ---------- */
const dataurl = 'https://script.google.com/macros/s/AKfycbwU43y7aw-hY8rjx77YgViB5Vs2H5yv7i5GMuUUfB6YMLbEQn3D/exec';
const timestampurl = 'https://script.google.com/macros/s/AKfycbwo-TtPn3DAjHSPCXDwPFerT36QyfPPvUTi7uQEvcmjJso_aWpaKefUsgx_vpJOowHUgg/exec?sheetid=1YIV80pXwoaMT4FeYfDIBcYSkhUz7iNTn_te7h9yylIY&sheetname=UpdatedOn';
const cacheStorageKey = 'ibap-cache';
const updatedOnKey = 'ibapUpdatedOn';
const mylocalKey = 'mylocal';

/* ---------- App state ---------- */
let data = [];
let filtered = [];
let currentView = 'login';
const today = new Date();
let baseList = [];
let baseView = 'members';

/* ---------- DOM refs ---------- */
const loginView = document.getElementById('loginView');
const reportView = document.getElementById('reportView');
const srnoInput = document.getElementById('srnoInput');
const srSubmit = document.getElementById('srSubmit');
const loginMsg = document.getElementById('loginMsg');
const searchInput = document.getElementById('searchInput');
const cardsWrap = document.getElementById('cards');
const reportInfo = document.getElementById('reportInfo');
const refreshDataBtn = document.getElementById('refreshData');
const modalBack = document.getElementById('modalBack');
const modalClose = document.getElementById('modalClose');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');
const hamb = document.getElementById('hamb');
const sidebar = document.getElementById('sidebar');
const clearLocalBtn = document.getElementById('clearLocal');
const statusEl = document.getElementById('status');
const countMembersBadge = document.getElementById('countMembers');

/* ---------- Helpers ---------- */
function logStatus(msg){ statusEl.textContent = msg; }
function setLoginMessage(msg){ loginMsg.textContent = msg; }
function saveCache(arr){ try{ localStorage.setItem(cacheStorageKey, JSON.stringify(arr)); }catch(e){} }
function loadCache(){ try{ const s = localStorage.getItem(cacheStorageKey); return s ? JSON.parse(s) : null; }catch(e){ return null; } }
function saveUpdatedOn(val){ localStorage.setItem(updatedOnKey, val); }
function getUpdatedOn(){ return localStorage.getItem(updatedOnKey); }
function setMylocal(val){ localStorage.setItem(mylocalKey, val); }
function getMylocal(){ return localStorage.getItem(mylocalKey); }
function clearMylocal(){ localStorage.removeItem(mylocalKey); }
function parseMylocal(str){ if(!str) return null; const parts = str.split('#'); if(parts.length<1) return null; const srno = Number(parts[0])||null; return {srno, raw:str, name:parts[1]||''}; }
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }
function cleanBranchList(str){ if(!str) return ''; return str.split(',').map(s=>s.trim()).filter(s=>s).join(', '); }

/* ---------- Rendering ---------- */

function renderCarouselCards(list) {
  cardsWrap.innerHTML = '';
  if (!list || list.length === 0) {
    cardsWrap.innerHTML = '<div style="padding:18px">No events</div>';
    return;
  }

  // Sort by name (non-destructive)
//  const sorted = list.slice().sort((a,b)=> (String(a.name||'')).localeCompare(String(b.name||'')));
const sorted = list.slice().sort((a, b) => {
  const dateA = new Date(a._eventWhen);
  const dateB = new Date(b._eventWhen);
  return dateA - dateB;
});

  // Carousel structure
  const wrap = document.createElement('div');
  wrap.id = 'carouselWrap';

  sorted.forEach((item, i) => {
    const el = document.createElement('div');
    el.className = 'carousel-card' + (i === 0 ? ' active' : '');
    const eventBadge = item._eventType ? `<span class="badge">${escapeHtml(item._eventType)}</span>` : '';
    const whenText = item._eventWhen ? ` â€¢ ${new Date(item._eventWhen).toDateString()}` : '';
    el.innerHTML = `
  <div style="width:100%;text-align:center;">
    <img src="https://drive.google.com/thumbnail?id=${item.photoid || ''}" 
         alt="Photo" style="display:block;margin:auto;height:120px;width:auto;max-width:96%;border-radius:12px;object-fit:cover;box-shadow:0 2px 10px rgba(0,0,0,0.12);background:#eee;">
  </div>
  <h3 style="margin-top:10px;margin-bottom:5px; text-align:centre;">${escapeHtml(item.name || 'No name')} </h3> <p>${eventBadge}</p>
  <p style="margin:5px 0 2px 0;color:#555;">${escapeHtml(item.add3 || '')} ${whenText}</p>
  <p style="margin:2px 0 0 0;font-size:13px;color:#777;">SR No: ${item.srno || ''} ${item.mob1 ? 'â€¢ ' + item.mob1 : ''}</p>
`;

;
    el.addEventListener('click',()=>openModalFor(item));
    wrap.appendChild(el);
  });

  // Dots
  const dots = document.createElement('div');
  dots.id = 'carouselDots';
  sorted.forEach((item, i) => {
    const dot = document.createElement('div');
    dot.className = 'carousel-dot' + (i === 0 ? ' active' : '');
    dots.appendChild(dot);
  });

  cardsWrap.appendChild(wrap);
  cardsWrap.appendChild(dots);

  // Carousel autoplay logic
  let curIdx = 0;
  let timer = null;
  function showCarousel(idx){
    curIdx = idx;
    [...wrap.children].forEach((c,i)=>c.classList.toggle('active',i===idx));
    [...dots.children].forEach((d,i)=>d.classList.toggle('active',i===idx));
  }
  function nextCard(){
    curIdx = (curIdx+1)%sorted.length;
    showCarousel(curIdx);
  }
  timer = setInterval(nextCard,2000);

  [...dots.children].forEach((dot,i)=>{
    dot.onclick = ()=>{
      showCarousel(i);
      clearInterval(timer);
      timer = setInterval(nextCard,2000);
    };
  });

  showCarousel(0);
}

function renderCards(list){
  if(baseView==='events'){
    renderCarouselCards(list);
    return;
  }
  cardsWrap.innerHTML = '';
  if(!list || list.length===0){
    cardsWrap.innerHTML = '<div style="padding:18px">No results</div>';
    return;
  }

  const sorted = list.slice().sort((a,b)=> (String(a.name||'')).localeCompare(String(b.name||'')));

  sorted.forEach(item=>{
    const el = document.createElement('div');
    el.className = 'card';
    if(item.srno !== undefined && item.srno !== null){
      el.id = `srno-${item.srno}`;
    }
    el.tabIndex = 0;
    const eventBadge = item._eventType ? `<span class="badge">${escapeHtml(item._eventType)}</span>` : '';
    const whenText = item._eventWhen ? ` â€¢ ${new Date(item._eventWhen).toDateString()}` : '';
    let cardHtml = '';
    if (baseView === 'places') {
      cardHtml = `<h3>${escapeHtml(item.name || 'No name')}</h3>`;
    } else if (baseView === 'branches') {
      cardHtml = `<h3>${escapeHtml(item.name || 'No name')}</h3>`;
    } else {
      cardHtml = `<h3>${escapeHtml(item.name || 'No name')} ${eventBadge}</h3>
        <p>SR No: ${item.srno || ''} â€¢ ${escapeHtml(item.add3 || '')} ${whenText} ${item.mob1 ? 'â€¢ ' + item.mob1 : ''}</p>`;
    }
    el.innerHTML = cardHtml;

    if(baseView === 'places'){
      el.setAttribute('data-place', item._place || item.name);
      el.addEventListener('click', ()=> {
        const place = el.getAttribute('data-place');
        const listMembers = data.filter(d=> (d.add3||'').trim() === place);
        baseView = 'members';
        baseList = listMembers.slice();
        runFilter(searchInput.value || '');
        reportInfo.textContent = `${baseList.length} members in ${place}`;
      });
    } else if(baseView === 'branches'){
      el.setAttribute('data-branch', item._branch || item.name);
      el.addEventListener('click', ()=>{
        const branch = el.getAttribute('data-branch');
        const listMembers = data.filter(d=>{
          const nb = d.newbrlist || '';
          const br = d.brlist || '';
          const inNew = nb && nb.split(',').map(s=>s.trim()).includes(branch);
          const inBr  = br && br.split(',').map(s=>s.trim()).includes(branch);
          return inNew || inBr;
        });
        baseView = 'members';
        baseList = listMembers.slice();
        searchInput.value = '';
        runFilter('');
        reportInfo.textContent = `${baseList.length} members Worked in ${branch} branch`;
      });
    } else {
      el.addEventListener('click', ()=> openModalFor(item));
    }
    cardsWrap.appendChild(el);
  });
}

/* ---------- Modal ---------- */
function openModalFor(item) {
  const monthsArray = [,'Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  modalTitle.textContent = item.name || 'Member';
  const bday = item.bm ? `<div style="margin-top:5px;"><strong>Events:</strong>Birthday ${monthsArray[item.bm]}- ${item.bd}</div>` : '';
  const mday = item.mm ? `<div style="margin-top:5px;"><strong>Events:</strong>Marriage Anniversary ${monthsArray[item.mm]}- ${item.md}</div>` : '';
  modalBody.innerHTML = `<table width=100%><tr><td>
    <div><strong>Address:</strong><br>
    ${item.add1}<br>
    ${item.add2}<br>
    ${item.add3},    ${item.add4}
    <div style="margin-top:8px;"><strong>Phones:</strong>
      ${item.mob1 || ''}
    </div>
      ${bday}  
       ${mday} 
    <div style="margin-top:5px;"><strong>Email:</strong>
      ${escapeHtml(item.email || '')}
    </div>
    <td id='myphoto'><img src='https://drive.google.com/thumbnail?id=${item.photoid}' alt='Photo'>
    <tr><td colspan=2>
    <div style="margin-top:5px;">
      <strong>Branches Worked:</strong> ${cleanBranchList(item.newbrlist)}
    </div></table>
  `;
  modalBack.classList.add('open');
}
function closeModal(){ modalBack.classList.remove('open'); }

/* ---------- Filtering logic ---------- */
function runFilter(q){
  const src = (baseList && baseList.length) ? baseList : data.slice();
  q = (q||'').trim().toLowerCase();

  if (baseView === 'branches') {
    filtered = src.filter(d => String(d.name||'').toLowerCase().includes(q));
  } else {
    if(!q) {
      filtered = src.slice();
    } else {
      filtered = src.filter(d=>{
        return (String(d.name||'').toLowerCase().includes(q))
          || (String(d.srno||'').toLowerCase().includes(q))
          || (String(d.add3||'').toLowerCase().includes(q));
      });
    }
  }
  filtered.sort((a,b)=> (String(a.name||'')).localeCompare(String(b.name||'')));
  renderCards(filtered);
  reportInfo.textContent = `${filtered.length} of ${src.length}`;
}

/* ---------- Unique lists ---------- */
function uniquePlaces(){
  const map = new Map();
  data.forEach(d=>{
    const place = (d.add3||'').trim();
    if(place) map.set(place, (map.get(place)||0)+1);
  });
  return Array.from(map.keys()).sort((a,b)=>a.localeCompare(b));
}
function uniqueBranches(){
  const set = new Set();
  data.forEach(d=>{
    if(d.newbrlist){
      d.newbrlist.split(',').map(s=>s.trim()).filter(Boolean).forEach(b=>set.add(b));
    }
  });
  return Array.from(set).sort((a,b)=>a.localeCompare(b));
}

/* ---------- Events logic ---------- */
function eventsThisWeek(){
  const results = [];
  const now = new Date();
  const end = new Date(now.getTime() + 7*24*3600*1000);
  function nextOccurrence(iso){
    try{
      if(!iso) return null;
      const d = new Date(iso);
      if(isNaN(d)) return null;
      const occ = new Date(now.getFullYear(), d.getMonth(), d.getDate());
      if(occ < now) occ.setFullYear(now.getFullYear()+1);
      return occ;
    }catch(e){return null;}
  }
  data.forEach(d=>{
    if(d.bm && d.bd){
      const mon = Number(d.bm)-1 || (isNaN(d.bm)?monthStrToNum(d.bm)-1:0);
      const day = Number(d.bd);
      if(mon>=0 && day>=1){
        const occ = new Date(now.getFullYear(), mon, day);
        if(occ < now) occ.setFullYear(now.getFullYear()+1);
        if(occ >= now && occ <= end) results.push({type:'Birthday', when:occ, item:d});
      }
    }
    if(d.mm && d.md){
      const mon = Number(d.mm)-1 || (isNaN(d.mm)?monthStrToNum(d.mm)-1:0);
      const day = Number(d.md);
      if(mon>=0 && day>=1){
        const occ = new Date(now.getFullYear(), mon, day);
        if(occ < now) occ.setFullYear(now.getFullYear()+1);
        if(occ >= now && occ <= end) results.push({type:'Marriage', when:occ, item:d});
      }
    }
  });
  results.sort((a,b)=>a.when-b.when);
  return results;
}
function monthStrToNum(s){
  if(!s) return NaN;
  const map = {jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12};
  const key = s.toString().toLowerCase().slice(0,3);
  return map[key] || NaN;
}

/* ---------- Data fetching ---------- */
async function fetchTimestamp(){
  try{
    const r = await fetch(timestampurl, {cache:'no-store'});
    if(!r.ok) throw new Error('ts fetch failed');
    const text = await r.text();
    try{
      const j = JSON.parse(text);
      if(typeof j === 'string') return j;
      if(j.updatedOn) return String(j.updatedOn);
      if(typeof j === 'object'){
        const v = Object.values(j)[0];
        return typeof v === 'string' ? v : JSON.stringify(j);
      }
    }catch(e){
      return text.trim();
    }
  }catch(e){
    return null;
  }
}
async function fetchDataFromServer(){
  try{
    logStatus('Downloading data...');
    const r = await fetch(dataurl, {cache:'no-store'});
    if(!r.ok) throw new Error('data fetch failed');
    const j = await r.json();
    const arr = Array.isArray(j.user) ? j.user : (Array.isArray(j) ? j : (j.data || []));
    data = arr;
    saveCache(data);
    const ts = await fetchTimestamp();
    if(ts) saveUpdatedOn(ts);
    logStatus('Data saved locally');
    return data;
  }catch(e){
    logStatus('Failed to download data');
    return null;
  }
}

/* ---------- App init ---------- */
async function checkAndUpdateCache(){
  try{
    const serverTs = await fetchTimestamp();
    const localTs = getUpdatedOn();
    if(serverTs && serverTs !== localTs){
      await fetchDataFromServer();
      renderAfterDataLoad();
      return true;
    } else if(!localTs){
      if(serverTs) saveUpdatedOn(serverTs);
      return false;
    } else {
      return false;
    }
  }catch(e){
    return false;
  }
}

/* ---------- UI Actions ---------- */
srSubmit.addEventListener('click', ()=>handleLoginSubmit(false));
srnoInput.addEventListener('keydown', (ev)=>{ if(ev.key === 'Enter') handleLoginSubmit(false); });
async function handleLoginSubmit(useLocal){
  setLoginMessage('');
  if(useLocal){
    const my = getMylocal();
    if(!my) { setLoginMessage('No mylocal in localStorage'); return; }
    const p = parseMylocal(my);
    if(!p || !p.srno) { setLoginMessage('Invalid mylocal value'); return; }
    if(!data || data.length===0){
      setLoginMessage('Loading cached data (or fetching from server)...');
      const c = loadCache();
      if(c && c.length>0) data = c;
      else {
        await fetchDataFromServer();
      }
    }
    if(!data || data.length===0){ setLoginMessage('No data available'); return; }
    showReportView();
    selectMember(p.srno);
    return;
  } else {
    const val = Number(srnoInput.value);
    if(!val){ setLoginMessage('Enter SR No'); return; }
    let c = loadCache();
    if(c && c.length>0) data = c;
    else {
      setLoginMessage('Fetching data from server...');
      await fetchDataFromServer();
    }
    if(!data || data.length===0){
      setLoginMessage('No data found');
      return;
    }
    const found = data.find(d=>Number(d.srno) === Number(val));
    if(found){
      const now = new Date();
      const mylocalVal = `${found.srno}#${found.name}#${now.toLocaleString('en-US',{month:'short'})} ${now.getDate()} ${now.getFullYear()} ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;
      setMylocal(mylocalVal);
      showReportView();
      selectMember(found.srno);
    } else {
      setLoginMessage('SR No not found in data.');
    }
  }
}

/* Show report view */
function showReportView(){
  currentView = 'report';
  loginView.style.display = 'none';
  reportView.style.display = '';
  if(!data || data.length===0){
    const c = loadCache(); if(c) data = c;
  }
  baseView = 'members';
  baseList = data.slice();
  renderAfterDataLoad();
}

/* Render after data loaded */
function renderAfterDataLoad(){
  if(!data) data = [];
  filtered = data.slice();
  baseList = data.slice();
  baseView = 'members';
  runFilter('');
  countMembersBadge.textContent = data.length || 0;
  reportInfo.textContent = `${filtered.length} of ${data.length}`;
  setLoginMessage('');
  setTimeout(() => {
    window.scrollTo({top: 0, left: 0, behavior: 'smooth'});
  }, 500);
}

/* Select a member */
function selectMember(srno){
  const m = data.find(d=>Number(d.srno) === Number(srno));
  if(m) {
    if(currentView !== 'report') showReportView();
    openModalFor(m);
    setTimeout(()=>{
      const el = document.getElementById(`srno-${m.srno}`);
      if(el) el.scrollIntoView({behavior:'smooth',block:'center'});
    },200);
  }
}

/* Search input */
searchInput.addEventListener('input', ()=>runFilter(searchInput.value));
refreshDataBtn.addEventListener('click', async ()=>{
  await fetchDataFromServer();
  baseView = 'members';
  baseList = data.slice();
  renderAfterDataLoad();
});

modalClose.addEventListener('click', closeModal);
modalBack.addEventListener('click', (ev)=>{ if(ev.target === modalBack) closeModal(); });

hamb.addEventListener('click', ()=>{ sidebar.classList.toggle('open'); sidebar.setAttribute('aria-hidden', !sidebar.classList.contains('open')) });
sidebar.addEventListener('click', (ev)=>{
  const mi = ev.target.closest('.menu-item');
  if(!mi) return;
  const act = mi.getAttribute('data-action');
  sidebar.classList.remove('open');
  window.scrollTo({top:0,left:0,behavior:'smooth'});
  if(act === 'listMembers') {
    showMembersList();
  } else if(act === 'eventsWeek'){
    showEventsWeek();
  } else if(act === 'membersLiving'){
    showMembersLiving();
  } else if(act === 'branchesList'){
    showBranchesList();
  } else if(act === 'dataCorrection' || act === 'otherLinks' || act === 'about'){
    alert('This section will be addressed later.');
  }
});
clearLocalBtn.addEventListener('click', ()=>{ clearMylocal(); alert('mylocal cleared'); });

/* Menu functions */
function showMembersList(){
  if(currentView !== 'report') showReportView();
  baseView = 'members';
  baseList = data.slice();
  runFilter(searchInput.value || '');
}
function showEventsWeek(){
  if(!data || data.length===0){
    alert('No data loaded. Please Refresh first.');
    return;
  }
  const evs = eventsThisWeek();
  if(evs.length===0){
    alert('No events this week.');
    return;
  }
  baseList = evs.map(e => {
    return Object.assign({}, e.item, {_eventType: e.type, _eventWhen: e.when});
  });
  baseView = 'events';
  runFilter(searchInput.value || '');
  reportInfo.textContent = `${baseList.length} upcoming events`;
}
function showMembersLiving(){
  if(!data || data.length===0) { alert('No data loaded.'); return; }
  const places = uniquePlaces();
  if(places.length===0){ alert('No places found in data'); return; }
  baseList = places.map(p => ({ name: p, _place: p }));
  baseView = 'places';
  runFilter(searchInput.value || '');
  reportInfo.textContent = `${places.length} places`;
}
function showBranchesList(){
  if(!data || data.length===0) { alert('No data loaded.'); return; }
  const branches = uniqueBranches();
  if(branches.length===0){ alert('No branches in data'); return; }
  baseList = branches.map(b => ({ name: b, _branch: b }));
  baseView = 'branches';
  runFilter(searchInput.value || '');
  reportInfo.textContent = `${branches.length} branches`;
}

/* ---------- Initialization ---------- */
(function init(){
  initApp();
})();
async function initApp(){
  const my = getMylocal();
  if(my){
    const parsed = parseMylocal(my);
    if(parsed && parsed.srno){
      const c = loadCache();
      if(c && Array.isArray(c)){
        data = c;
        showReportView();
        checkAndUpdateCache();
        return;
      } else {
        setLoginMessage('Found mylocal but no local data. Fetching data...');
        await fetchDataFromServer();
        if(data && data.length>0){
          showReportView();
          selectMember(parsed.srno);
        }else{
          setLoginMessage('Could not fetch data. Try Refresh.');
        }
        return;
      }
    }
  }
  const c = loadCache();
  if(c && Array.isArray(c)){
    data = c;
    setLoginMessage('Loaded from cache. You may submit SR No');
    checkAndUpdateCache();
    return;
  }
  setLoginMessage('No cache present. Data will be fetched when needed or on Refresh.');
}

/* Go Up Button */
const goUpBtn = document.getElementById('goUpBtn');
goUpBtn.title = "Go Up";
let hideTimeout = null;
function showGoUpButton() {
  clearTimeout(hideTimeout);
  goUpBtn.style.display = 'flex';
  hideTimeout = setTimeout(() => {
    goUpBtn.style.display = 'none';
  }, 3000);
}
window.addEventListener('scroll', () => {
  showGoUpButton();
});
goUpBtn.onclick = () => window.scrollTo({top:0, left:0, behavior:'smooth'});
function writeToLog(srno,name){
  formData = new FormData();
  formData.append('fname', srno);
  formData.append('lname', name );
  fetch("https://script.google.com/macros/s/AKfycbyfHambsSuB4tIQiUIIqIf72m7zgl7hT4FsW8N3TIVeQu9U6Po/exec",{body: formData,method: "post"});
}


</script>
</body>
</html>
