<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="theme-color" content="red" />
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="ibap512.png">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins&effect=neon|outline|emboss|shadow-multiple">
  <title>IBAP Retirees</title>

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --accent:#0b67ff; --muted:#666; --header:#ed8d8d;
    }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:#111}

    /* header */
    header{
      position:fixed;left:0;right:0;top:0;height:56px;background:var(--header);border-bottom:1px solid #eee;display:flex;align-items:center;gap:12px;padding:0 12px;z-index:30
    }
    header h1{margin:0;font-size:18px;letter-spacing:1px;text-align:center}
    .hamb{width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:8px;cursor:pointer}

    main{padding:76px 12px 24px;max-width:980px;margin:0 auto}

    /* login */
    .login-box{background:var(--card);padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(20,20,40,0.04);max-width:560px;margin:20px auto}
    label{display:block;margin-bottom:6px;font-weight:600}
    input[type="number"], input[type="search"], input[type="text"]{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;font-size:15px}
    .row{display:flex;gap:8px;align-items:center;margin-top:10px}
    button{background:var(--accent);color:#fff;padding:10px 14px;border-radius:8px;border:0;font-weight:600;cursor:pointer}
    button.secondary{background:#eee;color:#111}
    small.muted{color:var(--muted);display:block;margin-top:6px}

    /* controls + cards */
    .controls{display:flex;gap:8px;margin-bottom:12px;align-items:center;flex-wrap:wrap;position:sticky;top:56px;background:var(--bg);z-index:25;padding:8px 12px;border-bottom:1px solid #eee}
    .cards{display:grid;grid-template-columns: repeat(auto-fill,minmax(240px,1fr));gap:12px;padding-top:8px}
    .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 12px rgba(10,10,30,0.03);cursor:pointer}
    .card h3{margin:0;font-size:16px}
    .card p{margin:6px 0 0 0;color:var(--muted);font-size:13px}

    /* sidebar */
    .sidebar{position:fixed;left:0;top:56px;bottom:0;width:280px;background:#fff;border-right:1px solid #eee;padding:14px;transform:translateX(-110%);transition:transform .25s ease;z-index:40;overflow:auto}
    .sidebar.open{transform:translateX(0)}
    .menu-item{padding:10px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
    .menu-item:hover{background:#f2f6ff}

    /* modal */
    .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:60;font-size:small}
    .modal-back.open{display:flex}
    .modal{background:#c02595; color:white; padding:16px;border-radius:12px;max-width:700px;width:95%;max-height:85vh;overflow:auto;box-shadow:0 20px 40px rgba(0,0,0,0.2)}
    .badge{display:inline-block;padding:6px 8px;border-radius:999px;background:#f1f3ff;color:#0b67ff;font-weight:700;font-size:12px}

    /* small responsive tweaks */
    @media (max-width:520px){ header h1{font-size:15px} .cards{grid-template-columns:1fr} .sidebar{width:88%} }
    .topnote{font-size:13px;color:var(--muted);margin-top:8px}

    /* go up button */
    #goUpBtn{position:fixed;top:50%;right:0;width:50px;height:50px;background:red;color:#fff;border-radius:50px;display:none;align-items:center;justify-content:center;cursor:pointer;z-index:100;font-size:20px;box-shadow:0 2px 8px rgba(0,0,0,0.2)}

    /* Modal photo
    Minor style customization kept as before for visual parity */
    #myphoto img{width:100px;height:120px;border-radius:12px;object-fit:cover;box-shadow:0 2px 12px rgba(0,0,0,0.2)}

    /* Carousel styles (compact, accessible) */
    #carouselWrap{position:relative;width:100%;max-width:340px;margin:0 auto 16px;min-height:275px;overflow:hidden}
    .carousel-card{position:absolute;left:0;top:0;right:0;bottom:0;opacity:0;transition:opacity .45s ease;pointer-events:none;z-index:5;min-height:200px;background:#fff;display:flex;flex-direction:column;align-items:center;padding:12px}
    .carousel-card.active{opacity:1;pointer-events:auto;z-index:10}
    #carouselDots{display:flex;gap:6px;justify-content:center;margin-top:8px}
    .carousel-dot{width:5px;height:5px;border-radius:50%;background:#ed8d8d7d;cursor:pointer}
    .carousel-dot.active{background:#ed8d8d}
  </style>
</head>
<body>
  <header>
    <div id="hamb" class="hamb" title="Menu" aria-label="Menu" style='background:red; color:white; width:60px;font-face:bold;'>
      <b>MENU</b>
    </div>
    <h1>IBAP RETIREES' GOOGLE GROUP</h1>
    <div style="flex:1"></div>
    <div id="status" style="font-size:13px;color:var(--muted)" aria-live="polite"></div>
  </header>

  <aside id="sidebar" class="sidebar" aria-hidden="true">
    <h4>Menu</h4>
    <div class="menu-item" data-action="listMembers">1. List of Members <span class="badge" id="countMembers"></span></div>
    <div class="menu-item" data-action="eventsWeek">2. Events this week</div>
    <div class="menu-item" data-action="membersLiving">3. Members living In</div>
    <div class="menu-item" data-action="branchesList">4. Branches list</div>
    <div class="menu-item" data-action="dataCorrection">5. Data correction</div>
    <div class="menu-item" data-action="otherLinks">6. Other Links</div>
    <div class="menu-item" data-action="about">7. About</div>
    <hr/>
    <div style="margin-top:8px"><button id="clearLocal" class="secondary" style="width:100%">Clear local mylocal</button></div>
  </aside>

  <main>
    <section id="loginView">
      <div class="login-box">
        <label for="srnoInput">Enter SR No</label>
        <input id="srnoInput" type="number" inputmode="numeric" placeholder="e.g. 1948" aria-label="SR Number" />
        <div class="row" style="margin-top:12px">
          <button id="srSubmit">Submit</button>
        </div>
        <div id="loginMsg" class="topnote" role="status" aria-live="polite"></div>
      </div>
    </section>

    <section id="reportView" style="display:none">
      <div class="controls">
        <input id="searchInput" type="search" placeholder="Search by name, srno, city..." aria-label="Search" />
        <button id="refreshData" class="secondary" style='display:none;'>Refresh</button>
        <div style="flex:1"></div>
        <div id="reportInfo" class="topnote"></div>
      </div>

      <!-- Carousel (shows when baseView === 'events') is rendered into #cards -->
      <div id="reportArea">
        <div id="cards" class="cards" aria-live="polite"></div>
      </div>
    </section>
  </main>

  <div id="goUpBtn" style="">TOP</div>

  <div id="modalBack" class="modal-back" role="dialog" aria-modal="true">
    <div class="modal" id="modal">
      <div>
        <h3 id="modalTitle" style="text-align:center"></h3>
        <div class="close" id="modalClose" title="Close" style="font-size:1.5em;cursor:pointer;display:none">&times;</div>
      </div>
      <div>
        <div id="modalBody"></div>
      </div>
    </div>
  </div>

  <script>
    /* ---------- Configuration ---------- */
    const CONFIG = {
      DATA_URL: 'https://script.google.com/macros/s/AKfycbwU43y7aw-hY8rjx77YgViB5Vs2H5yv7i5GMuUUfB6YMLbEQn3D/exec',
      TIMESTAMP_URL: 'https://script.google.com/macros/s/AKfycbwo-TtPn3DAjHSPCXDwPFerT36QyfPPvUTi7uQEvcmjJso_aWpaKefUsgx_vpJOowHUgg/exec?sheetid=1YIV80pXwoaMT4FeYfDIBcYSkhUz7iNTn_te7h9yylIY&sheetname=UpdatedOn',
      CACHE_KEY: 'ibap-cache',
      UPDATED_ON_KEY: 'ibapUpdatedOn',
      MYLOCAL_KEY: 'mylocal'
    };

    /* ---------- App state ---------- */
    let state = {
      data: [],        // full dataset
      filtered: [],
      baseList: [],
      baseView: 'members', // 'members' | 'events' | 'places' | 'branches'
      currentView: 'login'
    };
    const today = new Date();

    /* ---------- DOM refs ---------- */
    const refs = {
      loginView: document.getElementById('loginView'),
      reportView: document.getElementById('reportView'),
      srnoInput: document.getElementById('srnoInput'),
      srSubmit: document.getElementById('srSubmit'),
      loginMsg: document.getElementById('loginMsg'),
      searchInput: document.getElementById('searchInput'),
      cardsWrap: document.getElementById('cards'),
      reportInfo: document.getElementById('reportInfo'),
      refreshDataBtn: document.getElementById('refreshData'),
      modalBack: document.getElementById('modalBack'),
      modalClose: document.getElementById('modalClose'),
      modalTitle: document.getElementById('modalTitle'),
      modalBody: document.getElementById('modalBody'),
      hamb: document.getElementById('hamb'),
      sidebar: document.getElementById('sidebar'),
      clearLocalBtn: document.getElementById('clearLocal'),
      statusEl: document.getElementById('status'),
      countMembersBadge: document.getElementById('countMembers'),
      goUpBtn: document.getElementById('goUpBtn')
    };

    /* ---------- Small helpers ---------- */
    const logStatus = (msg) => { refs.statusEl.textContent = msg; };
    const setLoginMessage = (msg) => { refs.loginMsg.textContent = msg; };
    const saveCache = (arr) => { try { localStorage.setItem(CONFIG.CACHE_KEY, JSON.stringify(arr)); } catch (e) { console.warn(e); } };
    const loadCache = () => { try { const s = localStorage.getItem(CONFIG.CACHE_KEY); return s ? JSON.parse(s) : null; } catch (e) { return null; } };
    const saveUpdatedOn = (v) => { localStorage.setItem(CONFIG.UPDATED_ON_KEY, v); };
    const getUpdatedOn = () => localStorage.getItem(CONFIG.UPDATED_ON_KEY);
    const setMylocal = (v) => localStorage.setItem(CONFIG.MYLOCAL_KEY, v);
    const getMylocal = () => localStorage.getItem(CONFIG.MYLOCAL_KEY);
    const clearMylocal = () => localStorage.removeItem(CONFIG.MYLOCAL_KEY);

    const parseMylocal = (str) => {
      if (!str) return null;
      const parts = str.split('#');
      if (parts.length < 1) return null;
      return { srno: Number(parts[0]) || null, raw: str, name: parts[1] || '' };
    };

    const escapeHtml = (s) => String(s || '').replace(/[&<>\"']/g, (c) => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" })[c]);
    const cleanBranchList = (str) => str ? str.split(',').map(s => s.trim()).filter(Boolean).join(', ') : '';

    /* ---------- RENDER: CARDS & CAROUSEL ---------- */
    const renderCarouselCards = (list) => {
      const wrap = refs.cardsWrap;
      wrap.innerHTML = '';
      if (!list || list.length === 0) {
        wrap.innerHTML = '<div style="padding:18px">No events</div>';
        return;
      }

      // sort by event date (ensure Date objects)
      const sorted = list.slice().sort((a,b) => new Date(a._eventWhen) - new Date(b._eventWhen));

      const carousel = document.createElement('div');
      carousel.id = 'carouselWrap';

      sorted.forEach((item, i) => {
        const card = document.createElement('article');
        card.className = 'carousel-card' + (i === 0 ? ' active' : '');
        const whenText = item._eventWhen ? ` • ${new Date(item._eventWhen).toDateString()}` : '';
        card.innerHTML = `\n          <div style="width:100%;text-align:center;">\n            <img src="https://drive.google.com/thumbnail?id=${encodeURIComponent(item.photoid || '')}" alt="${escapeHtml(item.name)}" style="display:block;margin:auto;height:120px;width:auto;max-width:96%;border-radius:12px;object-fit:cover;box-shadow:0 2px 10px rgba(0,0,0,0.12);background:#eee;">\n          </div>\n          <h3 style="margin-top:10px;margin-bottom:5px;text-align:center">${escapeHtml(item.name || 'No name')}</h3>\n          <p style="margin:4px 0 0 0">${item._eventType ? '<span class="badge">' + escapeHtml(item._eventType) + '</span>' : ''}</p>\n          <p style="margin:6px 0 0 0;color:#555">${escapeHtml(item.add3 || '')} ${whenText}</p>\n          <p style="margin:6px 0 0 0;font-size:13px;color:#777">SR No: ${item.srno || ''} ${item.mob1 ? '• ' + escapeHtml(item.mob1) : ''}</p>\n        `;
        card.addEventListener('click', () => openModalFor(item));
        carousel.appendChild(card);
      });

      // dots
      const dots = document.createElement('div');
      dots.id = 'carouselDots';
      sorted.forEach((_, i) => {
        const d = document.createElement('button');
        d.className = 'carousel-dot' + (i === 0 ? ' active' : '');
        d.setAttribute('aria-label', 'Go to slide ' + (i+1));
        d.addEventListener('click', () => { showSlide(i); resetTimer(); });
        dots.appendChild(d);
      });

      wrap.appendChild(carousel);
      wrap.appendChild(dots);

      // carousel logic
      let current = 0;
      const slides = Array.from(carousel.children);
      const dotsList = Array.from(dots.children);
      let timer = null;

      function showSlide(idx){
        current = idx % slides.length;
        slides.forEach((s, i) => s.classList.toggle('active', i===current));
        dotsList.forEach((d, i) => d.classList.toggle('active', i===current));
      }
      function next(){ showSlide((current+1)%slides.length); }
      function resetTimer(){ clearInterval(timer); timer = setInterval(next, 3000); }

      // touch support (simple)
      let startX = null;
      carousel.addEventListener('touchstart', (ev) => { startX = ev.touches[0].clientX; clearInterval(timer); });
      carousel.addEventListener('touchend', (ev) => {
        if (startX === null) { resetTimer(); return; }
        const endX = ev.changedTouches[0].clientX;
        const diff = endX - startX;
        if (diff > 50) showSlide((current - 1 + slides.length) % slides.length);
        else if (diff < -50) showSlide((current + 1) % slides.length);
        startX = null;
        resetTimer();
      });

      // start
      showSlide(0);
      resetTimer();

      // expose to outer if needed
      return { showSlide };
    };

    const renderCards = (list) => {
      if (state.baseView === 'events') { renderCarouselCards(list); return; }

      const wrap = refs.cardsWrap;
      wrap.innerHTML = '';
      if (!list || list.length === 0) { wrap.innerHTML = '<div style="padding:18px">No results</div>'; return; }

      const sorted = list.slice().sort((a,b) => (String(a.name||'')).localeCompare(String(b.name||'')));
      sorted.forEach(item => {
        const el = document.createElement('div');
        el.className = 'card';
        if (item.srno !== undefined && item.srno !== null) el.id = `srno-${item.srno}`;
        el.tabIndex = 0;

        const eventBadge = item._eventType ? `<span class="badge">${escapeHtml(item._eventType)}</span>` : '';
        const whenText = item._eventWhen ? ` • ${new Date(item._eventWhen).toDateString()}` : '';

        let html = '';
        if (state.baseView === 'places' || state.baseView === 'branches') html = `<h3>${escapeHtml(item.name || 'No name')}</h3>`;
        else html = `<h3>${escapeHtml(item.name || 'No name')} ${eventBadge}</h3><p>SR No: ${item.srno || ''} • ${escapeHtml(item.add3||'')} ${whenText} ${item.mob1 ? '• ' + escapeHtml(item.mob1) : ''}</p>`;

        el.innerHTML = html;

        if (state.baseView === 'places') {
          el.dataset.place = item._place || item.name;
          el.addEventListener('click', () => {
            const place = el.dataset.place;
            state.baseView = 'members';
            state.baseList = state.data.filter(d => (d.add3||'').trim() === place).slice();
            runFilter('');
            refs.reportInfo.textContent = `${state.baseList.length} members in ${place}`;
          });
        } else if (state.baseView === 'branches') {
          el.dataset.branch = item._branch || item.name;
          el.addEventListener('click', () => {
            const branch = el.dataset.branch;
            const listMembers = state.data.filter(d => {
              const nb = d.newbrlist || '';
              const br = d.brlist || '';
              const inNew = nb && nb.split(',').map(s=>s.trim()).includes(branch);
              const inBr = br && br.split(',').map(s=>s.trim()).includes(branch);
              return inNew || inBr;
            });
            state.baseView = 'members';
            state.baseList = listMembers.slice();
            refs.searchInput.value = '';
            runFilter('');
            refs.reportInfo.textContent = `${state.baseList.length} members Worked in ${branch} branch`;
          });
        } else {
          el.addEventListener('click', () => openModalFor(item));
        }

        wrap.appendChild(el);
      });
    };

    /* ---------- MODAL ---------- */
    function openModalFor(item){
      const months = [,'Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      refs.modalTitle.textContent = item.name || 'Member';
      const bday = item.bm ? `<div style="margin-top:5px; width:max-content"><strong>Events:</strong> Birthday ${months[item.bm]} - ${item.bd}</div>` : '';
      const mday = item.mm ? `<div style="margin-top:5px;  width:max-content"><strong>Events:</strong> Marriage Anniversary ${months[item.mm]} - ${item.md}</div>` : '';

      refs.modalBody.innerHTML = `
        <table width="100%"><tr><td>
          <div><strong>Address:</strong><br>${escapeHtml(item.add1||'')}<br>${escapeHtml(item.add2||'')}<br>${escapeHtml(item.add3||'')}, ${escapeHtml(item.add4||'')}</div>
          <div style="margin-top:8px;"><strong>Phones:</strong> ${escapeHtml(item.mob1||'')}</div>
          ${bday}
          ${mday}
          <div style="margin-top:5px;"><strong>Email:</strong> ${escapeHtml(item.email||'')}</div>
        </td>
        <td id="myphoto" style="vertical-align:top;padding-left:12px; width:105px;"><img src="https://drive.google.com/thumbnail?id=${encodeURIComponent(item.photoid||'')}" alt="photo"></td></tr>
        <tr><td colspan="2"><div style="margin-top:8px;"><strong>Branches Worked:</strong> ${escapeHtml(cleanBranchList(item.newbrlist||''))}</div></td></tr>
        </table>
      `;

      refs.modalBack.classList.add('open');
    }
    function closeModal(){ refs.modalBack.classList.remove('open'); }

    /* ---------- FILTER ---------- */
    function runFilter(q){
      const src = (state.baseList && state.baseList.length) ? state.baseList : state.data.slice();
      q = (q||'').trim().toLowerCase();

      if (state.baseView === 'branches') {
        state.filtered = src.filter(d => String(d.name || '').toLowerCase().includes(q));
      } else {
        state.filtered = q ? src.filter(d => (String(d.name||'').toLowerCase().includes(q) || String(d.srno||'').toLowerCase().includes(q) || String(d.add3||'').toLowerCase().includes(q))) : src.slice();
      }

      state.filtered.sort((a,b) => (String(a.name||'')).localeCompare(String(b.name||'')));
      renderCards(state.filtered);
      refs.reportInfo.textContent = `${state.filtered.length} of ${src.length}`;
    }

    /* ---------- Unique lists & events ---------- */
    function uniquePlaces(){ const map = new Map(); state.data.forEach(d => { const place = (d.add3||'').trim(); if (place) map.set(place, (map.get(place)||0)+1); }); return Array.from(map.keys()).sort((a,b)=>a.localeCompare(b)); }
    function uniqueBranches(){ const set = new Set(); state.data.forEach(d => { if (d.newbrlist) d.newbrlist.split(',').map(s=>s.trim()).filter(Boolean).forEach(b=>set.add(b)); }); return Array.from(set).sort((a,b)=>a.localeCompare(b)); }

    function monthStrToNum(s){ if(!s) return NaN; const map = {jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12}; const key = String(s).toLowerCase().slice(0,3); return map[key]||NaN; }

    function eventsThisWeek() {
  const results = [];
  const today = new Date();
  today.setHours(0, 0, 0, 0); // reset to start of today
  const end = new Date(today.getTime() + 7 * 24 * 3600 * 1000);

  const nextOccurrence = (iso) => {
    if (!iso) return null;
    const d = new Date(iso);
    if (isNaN(d)) return null;
    const occ = new Date(today.getFullYear(), d.getMonth(), d.getDate());
    if (occ < today) occ.setFullYear(today.getFullYear() + 1);
    return occ;
  };

  state.data.forEach(d => {
    if (d.bm && d.bd) {
      const mon = Number(d.bm) - 1 || (isNaN(d.bm) ? monthStrToNum(d.bm) - 1 : 0);
      const day = Number(d.bd);
      if (mon >= 0 && day >= 1) {
        let occ = new Date(today.getFullYear(), mon, day);
        if (occ < today) occ.setFullYear(today.getFullYear() + 1);
        if (occ >= today && occ <= end) {
          results.push({ type: 'Birthday', when: occ, item: d });
        }
      }
    }
    if (d.mm && d.md) {
      const mon = Number(d.mm) - 1 || (isNaN(d.mm) ? monthStrToNum(d.mm) - 1 : 0);
      const day = Number(d.md);
      if (mon >= 0 && day >= 1) {
        let occ = new Date(today.getFullYear(), mon, day);
        if (occ < today) occ.setFullYear(today.getFullYear() + 1);
        if (occ >= today && occ <= end) {
          results.push({ type: 'Marriage Anniversary', when: occ, item: d });
        }
      }
    }
  });

  results.sort((a, b) => a.when - b.when);
  return results;
}


    /* ---------- Data fetch ---------- */
    async function fetchTimestamp(){
      try{
        const r = await fetch(CONFIG.TIMESTAMP_URL, {cache:'no-store'});
        if(!r.ok) throw new Error('ts fetch failed');
        const text = await r.text();
        try{ const j = JSON.parse(text); if (typeof j === 'string') return j; if (j.updatedOn) return String(j.updatedOn); if (typeof j === 'object'){ const v = Object.values(j)[0]; return typeof v === 'string' ? v : JSON.stringify(j); } }
        catch(e){ return text.trim(); }
      } catch(e){ console.warn(e); return null; }
    }

    async function fetchDataFromServer(){
      try{
        logStatus('Downloading data...');
        const r = await fetch(CONFIG.DATA_URL, {cache:'no-store'});
        if(!r.ok) throw new Error('data fetch failed');
        const j = await r.json();
        const arr = Array.isArray(j.user) ? j.user : (Array.isArray(j) ? j : (j.data || []));
        state.data = Array.isArray(arr) ? arr : [];
        saveCache(state.data);
        const ts = await fetchTimestamp(); if (ts) saveUpdatedOn(ts);
        logStatus('Data saved locally');
        return state.data;
      } catch (e) { console.warn(e); logStatus('Failed to download data'); return null; }
    }

    async function checkAndUpdateCache(){
      try{
        const serverTs = await fetchTimestamp();
        const localTs = getUpdatedOn();
        if (serverTs && serverTs !== localTs){ await fetchDataFromServer(); renderAfterDataLoad(); return true; }
        if (!localTs && serverTs) saveUpdatedOn(serverTs);
        return false;
      } catch(e){ console.warn(e); return false; }
    }

    /* ---------- UI actions & handlers ---------- */
    refs.srSubmit.addEventListener('click', () => handleLoginSubmit(false));
    refs.srnoInput.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') handleLoginSubmit(false); });

    async function handleLoginSubmit(useLocal){
      setLoginMessage('');
      if (useLocal){
        const my = getMylocal(); if (!my) { setLoginMessage('No mylocal in localStorage'); return; }
        const p = parseMylocal(my); if (!p || !p.srno) { setLoginMessage('Invalid mylocal value'); return; }
        if (!state.data || state.data.length === 0){ setLoginMessage('Loading cached data (or fetching from server)...'); const c = loadCache(); if (c && c.length>0) state.data = c; else await fetchDataFromServer(); }
        if (!state.data || state.data.length === 0) { setLoginMessage('No data available'); return; }
        showReportView(); selectMember(p.srno); return;
      }

      const val = Number(refs.srnoInput.value);
      if (!val) { setLoginMessage('Enter SR No'); return; }
      const c = loadCache(); if (c && c.length>0) state.data = c; else { setLoginMessage('Fetching data from server...'); await fetchDataFromServer(); }
      if (!state.data || state.data.length === 0) { setLoginMessage('No data found'); return; }
      const found = state.data.find(d => Number(d.srno) === Number(val));
      if (found){
      writeToLog(found.srno, found.name)
        const now = new Date();
        const mylocalVal = `${found.srno}#${found.name}#${now.toLocaleString('en-US',{month:'short'})} ${now.getDate()} ${now.getFullYear()} ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;
        setMylocal(mylocalVal);
        showReportView(); selectMember(found.srno);
      } else { setLoginMessage('SR No not found in data.'); }
    }

    function showReportView(){
      state.currentView = 'report'; refs.loginView.style.display = 'none'; refs.reportView.style.display = '';
      if (!state.data || state.data.length === 0) { const c = loadCache(); if (c) state.data = c; }
      state.baseView = 'members'; state.baseList = state.data.slice(); renderAfterDataLoad();
    }

    function renderAfterDataLoad(){
      if (!state.data) state.data = [];
      state.filtered = state.data.slice(); state.baseList = state.data.slice(); state.baseView = 'members'; runFilter(''); refs.countMembersBadge.textContent = state.data.length || 0; refs.reportInfo.textContent = `${state.filtered.length} of ${state.data.length}`; setLoginMessage('');
      setTimeout(() => window.scrollTo({top:0,left:0,behavior:'smooth'}), 400);
    }

    function selectMember(srno){ const m = state.data.find(d => Number(d.srno) === Number(srno)); if (m){ if (state.currentView !== 'report') showReportView(); openModalFor(m); setTimeout(()=>{ const el = document.getElementById(`srno-${m.srno}`); if (el) el.scrollIntoView({behavior:'smooth',block:'center'}); },200); } else alert('Member not found locally'); }

    refs.searchInput.addEventListener('input', () => runFilter(refs.searchInput.value));
    refs.refreshDataBtn.addEventListener('click', async () => { await fetchDataFromServer(); state.baseView = 'members'; state.baseList = state.data.slice(); renderAfterDataLoad(); });

    refs.modalClose.addEventListener('click', closeModal);
    refs.modalBack.addEventListener('click', (ev) => { if (ev.target === refs.modalBack) closeModal(); });

    refs.hamb.addEventListener('click', () => { refs.sidebar.classList.toggle('open'); refs.sidebar.setAttribute('aria-hidden', !refs.sidebar.classList.contains('open')); });

    refs.sidebar.addEventListener('click', (ev) => {
      const mi = ev.target.closest('.menu-item'); if (!mi) return; const act = mi.getAttribute('data-action'); refs.sidebar.classList.remove('open'); window.scrollTo({top:0,left:0,behavior:'smooth'});
      if (act === 'listMembers') showMembersList(); else if (act === 'eventsWeek') showEventsWeek(); else if (act === 'membersLiving') showMembersLiving(); else if (act === 'branchesList') showBranchesList(); else alert('This section will be addressed later.');
    });

    refs.clearLocalBtn.addEventListener('click', () => { clearMylocal(); alert('mylocal cleared'); });

    /* Menu functions */
    function showMembersList(){ if (state.currentView !== 'report') showReportView(); state.baseView = 'members'; state.baseList = state.data.slice(); runFilter(refs.searchInput.value || ''); }

    function showEventsWeek(){ if (!state.data || state.data.length === 0) { alert('No data loaded. Please Refresh first.'); return; } const evs = eventsThisWeek(); if (evs.length === 0) { alert('No events this week.'); return; } state.baseList = evs.map(e => Object.assign({}, e.item, {_eventType: e.type, _eventWhen: e.when})); state.baseView = 'events'; runFilter(refs.searchInput.value || ''); refs.reportInfo.textContent = `${state.baseList.length} upcoming events`; }

    function showMembersLiving(){ if (!state.data || state.data.length === 0) { alert('No data loaded.'); return; } const places = uniquePlaces(); if (places.length === 0) { alert('No places found in data'); return; } state.baseList = places.map(p => ({ name: p, _place: p })); state.baseView = 'places'; runFilter(refs.searchInput.value || ''); refs.reportInfo.textContent = `${places.length} places`; }

    function showBranchesList(){ if (!state.data || state.data.length === 0) { alert('No data loaded.'); return; } const branches = uniqueBranches(); if (branches.length === 0) { alert('No branches in data'); return; } state.baseList = branches.map(b => ({ name: b, _branch: b })); state.baseView = 'branches'; runFilter(refs.searchInput.value || ''); refs.reportInfo.textContent = `${branches.length} branches`; }

    /* ---------- Initialization ---------- */
    (function init(){ initApp(); })();

    async function initApp(){
      const my = getMylocal();
      if (my){ const parsed = parseMylocal(my); if (parsed && parsed.srno){writeToLog(parsed.srno, parsed.name); const c = loadCache(); if (c && Array.isArray(c)){ state.data = c; showReportView(); checkAndUpdateCache(); return; } else { setLoginMessage('Found mylocal but no local data. Fetching data...'); await fetchDataFromServer(); if (state.data && state.data.length>0){ showReportView(); selectMember(parsed.srno); } else setLoginMessage('Could not fetch data. Try Refresh.'); return; } } }

      const c = loadCache(); if (c && Array.isArray(c)){ state.data = c; setLoginMessage('Loaded from cache. You may submit SR No'); checkAndUpdateCache(); return; }
      setLoginMessage('No cache present. Data will be fetched when needed or on Refresh.');
    }

    /* go up button */
    let hideTimeout = null;
    function showGoUpButton(){ clearTimeout(hideTimeout); refs.goUpBtn.style.display = 'flex'; hideTimeout = setTimeout(()=>{ refs.goUpBtn.style.display = 'none'; }, 3000); }
    window.addEventListener('scroll', showGoUpButton);
    refs.goUpBtn.onclick = () => window.scrollTo({top:0,left:0,behavior:'smooth'});

    /* telemetry/log small helper */
    function writeToLog(srno, name){ const formData = new FormData(); formData.append('fname', srno); formData.append('lname', name); fetch('https://script.google.com/macros/s/AKfycbyfHambsSuB4tIQiUIIqIf72m7zgl7hT4FsW8N3TIVeQu9U6Po/exec', { body: formData, method: 'post' }); }

  </script>
</body>
</html>
